StravaAI API
============

AI-powered Strava analytics and insights built with FastAPI, MongoDB, and optional LLM integrations. The service ingests your Strava activities, computes analytics, and generates concise coaching-style insights per activity and for time periods.

## Introduction
StravaAI connects to Strava via OAuth, securely stores tokens, syncs activities to MongoDB, exposes analytics endpoints, and can generate AI insights using pluggable providers. The API is structured around clear modules for auth, users, activities, analytics, and insights, with CORS and session support for a separate frontend.

## Features
- Secure Strava OAuth with token refresh and JWT-based sessions
- Encrypted token storage using Fernet with a required `ENCRYPTION_KEY`
- Activity sync from Strava with robust upsert and timestamping
- User profile management and milestone CRUD
- Analytics: dashboard summary, by-sport breakdowns, trend time series
- AI insights: per-activity insight generation and period summaries

## Requirements
- Python 3.10+
- MongoDB 5.0+ running locally or reachable via `MONGODB_URI`
- A Strava API application (client ID/secret and redirect URI)
- Environment variables in a `.env` file (see below)
- Optional: OpenAI or other provider API key live LLM insights

### Environment variables (.env)
Provide these settings in a `.env` file at the project root. The encryption key must be provided by you and should not be generated by the app.

```
# Strava OAuth
STRAVA_CLIENT_ID=your_strava_client_id
STRAVA_CLIENT_SECRET=your_strava_client_secret
STRAVA_REDIRECT_URI=http://localhost:8000/exchange_token

# Security
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
ENCRYPTION_KEY=your-fernet-key-base64

# Frontend integration
FRONTEND_URL=http://localhost:3000

# Database
MONGODB_URI=mongodb://localhost:27017

# App
DEBUG=True
HOST=0.0.0.0
PORT=8000

# AI (optional)
AI_PROVIDER=openai
AI_MODEL=gpt-4o-mini
OPENAI_API_KEY=your_openai_key
```

Notes:
- Generate a Fernet key for `ENCRYPTION_KEY` using a secure method 
- If no AI key is provided, the AI client returns a deterministic mock response suitable for development.

## How to run
1. Create and activate a virtual environment
   - macOS/Linux: `python3 -m venv venv && source venv/bin/activate`
   - Windows (PowerShell): `py -m venv venv; venv\\Scripts\\Activate.ps1`
2. Install dependencies
   - `pip install -r requirements.txt`
3. Create `.env` with the variables listed above
4. Start MongoDB locally or point `MONGODB_URI` to your instance
5. Run the API
   - Easiest: `python run_app.py`
   - Or: `uvicorn main:app --reload --host 0.0.0.0 --port 8000`

Health check: `GET /health` returns `{ "status": "healthy" }`.

## App modules
This project follows a clear module layout under `app/`. Key modules and routes are summarized below.

### Entry point: `main.py`
- Initializes `FastAPI` with title/description/version
- Adds `CORSMiddleware` for local frontends (localhost:3000/3001)
- Adds `SessionMiddleware` using `JWT_SECRET` as the session key
- Mounts routers:
  - `auth_router` (auth + Strava OAuth)
  - `user_router` (user profile + milestones)
  - `activity_router` (activities)
  - `analytics_router` (analytics)
  - `ai_router` (insights)
- Root endpoints:
  - `GET /` basic info
  - `GET /health` health check

### Routes

#### Auth (`app/auth_routes.py`)
- `GET /api/auth/user` — current user info from session JWT; refreshes Strava tokens if needed
- `GET /api/auth/status` — `{ authenticated: boolean, user?: ... }`
- `POST /api/auth/logout` — clears session
- `POST /api/auth/refresh?force=bool` — server-side refresh of Strava tokens and session JWT
- Strava OAuth sub-routes (`app/auth/strava_oauth.py`):
  - `GET /api/auth/strava/authorize-url` — returns the authorization URL (testing)
  - `GET /api/auth/strava/authorize` — begins OAuth flow; may refresh if valid
  - `GET /exchange_token` — OAuth callback: saves tokens, issues JWT, sets session

Security highlights:
- Access/refresh tokens are AES-Fernet encrypted at rest via `app/utils/encryption.py`
- Refresh is strictly server-side; refresh tokens are never sent to clients

#### User (`app/user_routes.py`, prefix `/api/user`)
- `GET /profile` — fetch current user profile
- `PUT /profile` — update partial profile fields
- Milestones
  - `GET /milestones` — list current user milestones
  - `POST /milestones` — create; server adds ID and timestamps
  - `PUT /milestones/{milestone_id}` — update
  - `DELETE /milestones/{milestone_id}` — delete
- `POST /sync-profile` — fetch latest profile from Strava and update local user

#### Activities (`app/activity_routes.py`, prefix `/api/activities`)
- `GET /` — list with pagination/filtering (`page`, `per_page`, `activity_type`, `after`, `before`)
- `GET /id/{activity_id}` — fetch by internal ID (Mongo ObjectId)
- `GET /strava/{strava_id}` — fetch by Strava activity ID
- `GET /stats/summary` — 30-day stats for Run/Ride/Swim including notable activities
- `POST /sync?days_back=180` — pull recent activities from Strava and upsert to DB; optionally triggers AI generation for recent ones
- `GET /recent?limit=10` — latest activities

#### Analytics (`app/analytics_routes.py`, prefix `/api/analytics`)
- `GET /dashboard?days_back=30` — overall summary, by-sport breakdown, and user milestones
- `GET /trends?metric=distance&period=day&activity_type=&days_back=90` — metric timeseries grouped by day/week/month

#### Insights (`app/ai_routes.py`, prefix `/api/insights`)
- `POST /activity/{activity_id}/generate?force=false` — generate insights for a specific activity
- `GET /activity/{activity_id}` — fetch existing or generate-on-demand insights
- `POST /bulk/recent?limit=5` — generate insights for recent activities lacking them
- `GET /summary?days_back=30` — AI summary for a period using analytics aggregates

### Models (`app/models`)

#### `user.py`
- `UserBase` — Strava identity and profile fields
- `UserCreate` — includes `access_token`, `refresh_token` (encrypted), `token_expires_at`
- `UserUpdate` — optional fields for partial updates
- `UserResponse` — safe response shape with ID/timestamps and `milestones`
- `MilestoneCreate` / `Milestone` / `MilestoneUpdate` — milestone structures

#### `activity.py`
- `ActivityBase` — core activity fields (Strava IDs, distance, time, elevation, etc.)
- `ActivityCreate` — creation shape with optional metrics
- `ActivityUpdate` — partial updates
- `ActivityResponse` — response shape with internal ID, timestamps, and optional `insights`
- `ActivityStats` — aggregated stats shape

### AI (`app/ai`)
- `providers.py` — `AIClient` abstraction using LiteLLM; loads provider/model from env; returns mock JSON when no API key provided
- `prompt_builder.py` — helpers to build system/user prompts for activity and period summaries
- `insight_service.py` — orchestrates context building, AI call, payload coercion/validation, and DB persistence; exposes methods for per-activity, bulk, and period summaries

### Database (`app/database/db_operations.py`)
- MongoDB connection via Motor; collections: `users`, `activities`
- User ops: create/get/update tokens/profile/milestones
- Activity ops: upsert by Strava ID, pagination/filters, stat aggregations, trends, and notable activities

### Auth core
- `app/auth/jwt.py` — create/validate/decode JWT; session JWT secret from `JWT_SECRET`
- `app/auth/strava_oauth.py` — OAuth wiring, token exchange/refresh, persistence, and redirects
- `app/utils/encryption.py` — AES-Fernet encryption using `ENCRYPTION_KEY` from `.env`



